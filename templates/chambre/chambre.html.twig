{% extends 'base.html.twig' %}

{% block stylesheets %}
<style>
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    overflow: hidden;
    font-family: 'ITC Benguiat Std', sans-serif;
}

.chambre-page {
    position: relative;
    width: 100%;
    height: 100vh;
    background: url('/images/chambre.png') center/cover no-repeat;
}

.lampe, .livre, .tableau {
    position: absolute;
    cursor: pointer;
}

.lampe { top: 100px; left: 200px; width: 50px; }
.livre { top: 649px; left: 600px; width: 120px; transform: translate(-50%, -50%); }
.tableau {
    position: absolute;
    top: 39.1%;   /* 304 / 1080 * 100 */
    left: 64.3%;  /* 889 / 1920 * 100 */
    width: 11.1%;  /* 148 / 1920 * 100 */
    height: 11.9%; /* 90 / 1080 * 100 */
    background-color: rgba(255,255,0,0.2);
    box-shadow: 0 0 20px 5px yellow;
    border: 2px solid gold;
    border-radius: 8px;
    animation: pulse 2s infinite alternate;
}


@keyframes pulse {
    0% { box-shadow: 0 0 10px 2px yellow; }
    100% { box-shadow: 0 0 30px 10px yellow; }
}

.indice-livre {
    position: absolute;
    top: 500px; left: 650px;
    color: white; font-size: 18px; line-height: 1.4;
    display: none; background-color: rgba(0,0,0,0.6);
    padding: 10px; border-radius: 10px; max-width: 300px;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    transition: opacity 2s ease;
}

/* === Overlay noir transparent === */
#overlay-intro {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.85);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: white;
    font-size: 24px;
    padding: 20px;
    z-index: 2000;
    opacity: 0;
    transition: opacity 1s ease;
    visibility: hidden;
}
#overlay-intro.show {
    opacity: 1;
    visibility: visible;
}
#overlay-intro p {
    max-width: 600px;
    margin-bottom: 20px;
}
#overlay-intro .peluche-start {
    width: 120px;
    cursor: pointer;
    transition: transform 0.3s ease;
}
#overlay-intro .peluche-start:hover {
    transform: scale(1.1);
}

/* Alphabet et input */
#letters span {
    display:inline-block; margin:5px; padding:10px 12px;
    border:1px solid white; cursor:pointer; font-size:24px;
    transition: all 0.3s;
}
#letters span.highlight { color: yellow; text-shadow: 0 0 10px yellow; }
#word-input {
    font-size: 20px; padding: 8px; margin-top: 20px;
    border-radius: 5px; border: 1px solid #fff; background-color: rgba(0,0,0,0.3);
    color: white; text-align: center;
}
#validate-btn {
    margin-top: 15px; padding: 10px 20px; font-size: 18px;
    border:none; border-radius:5px; background-color: gold; cursor:pointer;
    color: black;
}

.overlay {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background-color: rgba(0,0,0,0.85);
    display: none; justify-content: center; align-items: center;
    flex-direction: column; z-index: 1000; color: white;
}
</style>
{% endblock %}

{% block body %}
<div class="chambre-page">
    <img src="/images/livre.png" class="livre" id="livre" alt="Livre">
    <div class="tableau" id="tableau"></div>

    <div class="indice-livre" id="indice-livre">
        « Les lettres brillent…<br>Saurez-vous les assembler pour découvrir le mot caché ? »
    </div>
</div>

<!-- === Fenêtre d’intro === -->
<div id="overlay-intro">
    <p>
        Vous êtes dans la chambre de Will...<br><br>
        Les murs tremblent, les lumières clignotent.<br>
        Quelque chose cherche à communiquer à travers ce tableau.<br><br>
        
    </p>
    <img src="/images/des.png" alt="Commencer" class="peluche-start" style="width:60px; height:60px;">

</div>

<div class="overlay" id="overlay">
    <div id="letters"></div>
    <input type="text" id="word-input" placeholder="Formez le mot">
    <button id="validate-btn">Valider</button>
</div>

<audio id="bg-music" src="/sounds/musique.mp3" loop></audio>
<audio id="page-turn-sound" src="/sounds/livre.mp3" preload="auto"></audio>
<audio id="tableau-sound" src="/sounds/tableau.mp3" preload="auto"></audio>
<audio id="correct-sound" src="/sounds/correct.mp3" preload="auto"></audio>
<audio id="wrong-sound" src="/sounds/wrong.mp3" preload="auto"></audio>
<audio id="door-sound" src="/sounds/door.mp3" preload="auto"></audio>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    const livre = document.getElementById('livre');
    const indice = document.getElementById('indice-livre');
    const music = document.getElementById('bg-music');
    const pageTurn = document.getElementById('page-turn-sound');
    const tableau = document.getElementById('tableau');
    const overlay = document.getElementById('overlay');
    const lettersContainer = document.getElementById('letters');
    const input = document.getElementById('word-input');
    const validateBtn = document.getElementById('validate-btn');
    const tableauSound = document.getElementById('tableau-sound');
    const correctSound = document.getElementById('correct-sound');
    const wrongSound = document.getElementById('wrong-sound');
    const introOverlay = document.getElementById('overlay-intro');
    const startPeluche = document.querySelector('.peluche-start');
    const doorSound = document.getElementById('door-sound');

    // === Intro overlay ===
    setTimeout(()=> introOverlay.classList.add('show'), 300);
    startPeluche.addEventListener('click', ()=>{
        introOverlay.classList.remove('show');
        doorSound.play().catch(e => console.log("Impossible de jouer le son :", e));
    });

    // Musique autoplay au premier clic
    document.addEventListener('click', () => {
        if(music.paused) music.play();
    }, { once: true });

    // Livre clic
    livre.addEventListener('click', ()=>{
        if(indice.style.display==='none' || !indice.style.display){
            indice.style.display='block';
            indice.style.opacity=0;
            setTimeout(()=>indice.style.opacity=1,50);
        } else {
            indice.style.opacity=0;
            setTimeout(()=>indice.style.display='none',600);
        }
        pageTurn.play();
    });

    // Alphabet sur 3 lignes
    const letters = [
      ['A','B','C','D','E','F','G','H','I'],
      ['J','K','L','M','N','O','P','Q','R'],
      ['S','T','U','V','W','X','Y','Z']
    ];
    const solution = "WORLD";

    // Effet apparition + illumination
    tableau.addEventListener('click', ()=>{
        overlay.style.display='flex';
        overlay.style.opacity=0;
        tableauSound.play();

        setTimeout(()=>{ overlay.style.transition="opacity 2s"; overlay.style.opacity=1; },50);

        // Remplir les lettres
        lettersContainer.innerHTML='';
        let spans = [];
        letters.forEach(line => {
            const lineDiv = document.createElement('div');
            line.forEach(l=>{
                const span = document.createElement('span');
                span.textContent=l;
                span.addEventListener('click', ()=> input.value += l);
                lineDiv.appendChild(span);
                spans.push(span);
            });
            lettersContainer.appendChild(lineDiv);
        });
        input.value='';

        // Illumination progressive
        setTimeout(()=>{
            let i=0;
            const toHighlight = spans.filter(s => solution.includes(s.textContent));
            const interval = setInterval(()=>{
                if(i < toHighlight.length){
                    toHighlight[i].classList.add('highlight');
                    i++;
                } else {
                    clearInterval(interval);
                }
            }, 800);
        },4000);
    });

    // Validation mot
    validateBtn.addEventListener('click', ()=>{
        if(input.value.toUpperCase() === solution){
            correctSound.play();
            window.location.assign('/inverse');
        } else {
            wrongSound.play();
            input.value='';
        }
    });
});
</script>
{% endblock %}
